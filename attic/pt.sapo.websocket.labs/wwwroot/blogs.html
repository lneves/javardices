<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Sapo Blogs DashBoard</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<script type="text/javascript" src="jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="swfobject.js"></script>
		<script type="text/javascript" src="FABridge.js"></script>
		<script type="text/javascript" src="web_socket.js"></script>
		<script type="text/javascript" src="jquery.sparkline.min.js"></script>
		<link rel="stylesheet" href="css/style.css" type="text/css" />
		<script type="text/javascript">

WebSocket.__swfLocation = "WebSocketMain.swf";
var ws_host = "ws://" + window.location.host + "/websocket/blogstats";
var ws;

function init() {

	if (window.WebSocket) {

		ws = new WebSocket(ws_host);
		output("Your browser rocks! It supports Web Sockets.");
	} else {
		output("This sucks! Your browser doesn't have Web Sockets.");
	}

	ws.onopen = function () {
		output("Web Socket Opened");
	};

	ws.onmessage = function (event) {

		try {

			var obj

			try {
				obj = JSON.parse(event.data);
			}
			catch (e) {
				obj = eval('(' + event.data + ')');
			}

			if(obj.type == "global_status") {
				handleGlobalStatus(obj);
			}
			else if(obj.type == "top_hosts") {
				handleTopHosts(obj);
			}
			else if(obj.type == "top_pages") {
				handleTopPages(obj);
			}
			else if(obj.type == "new_blog_post") {
				handleBlogPost(obj);
			}
		}
		catch (err) {
			output("oops! something is wrong: " + err.message);
		}
	};
	ws.onclose = function () {
		output("Web Socket Closed");
		setTimeout("location.reload(true);", 10000);
	};

}


function handleSourceStats(obj) {

var bvalues = new Array();

bvalues[0] = obj.vdirect;
bvalues[1] = obj.vsearch;
bvalues[2] = obj.vrefered;

output( obj.vdirect);

$('#sources_chart').sparkline(bvalues, { type:'pie', width:'250px', height:'250px'});

}

function handleBlogPost(obj) {
	$("#li_loading").remove();
	addFirst(obj);
}

function removeLast() {
	$('ul#blogticker li:last').animate({
		opacity: 0
	}, 200).fadeOut(200, function () {
		$(this).remove();
	});
	$('ul#blogticker li:last').remove();
}

function addFirst(obj) {

	while ($("ul#blogticker").children().length > 10) {
		removeLast();
	}


	var first = '<li style="display:none; border-top:1px solid #444">';
	first += '<div><a href="' + obj.url + '">' + trunc(obj.title, 50) + '</a></div>';
	//first += '<div>' + obj.title + '</div>';
	first += '<div><span>From: ' + obj.author + '</span></div>';
	//first += '<div>' + obj.author + '</div>';
	first += '</li>';
	$('ul#blogticker').prepend(first);
	$('ul#blogticker li:first').animate({
		opacity: 1
	}, 200).fadeIn(200);
}

function handleGlobalStatus(obj) {

	var content = '<table id="t_gstatus" cellspacing="0" cellpadding="5" border="0" style="margin:auto; width:95%;">';
	content += '<caption>Active Visits</caption>';
	content += '<tr><td colspan="2"><h1 style="font-weight:bold; font-size:5.0em; text-align:center; margin:0.5em;color:#000">' + obj.total_visits + '</h1></td></tr>';

	content += '<tr><td colspan="2" style="text-align:center"><span id="box-plot">Loading...</span></td></tr>';

	content += '<tr>';
	content += '<td style="text-align:center"><div style="color:#707070">7-Day Min</div><div style="font-size:1.2em">' + obj.seven_day_min + '</div></td>';
	content += '<td style="text-align:center;"><div style="color:#707070">7-Day Max</div><div style="font-size:1.2em">' + obj.seven_day_max + '</div></td>';
	content += '</tr>';

	content += '<tr>';
	content += '<td style="text-align:center;border-top:1px solid #444"><div style="color:#707070">New</div><div style="font-size:1.2em">' + obj.new_visits + '</div></td>';
	content += '<td style="text-align:center;border-top:1px solid #444"><div style="color:#707070">Returning</div><div style="font-size:1.2em">' + obj.returning_visits + '</div></td>';
	content += '</tr>';
	
	content += '</table>';

	var bvalues = new Array();

	for(var i =0, l=obj.box_plot_data.length; i<l; i++ ) {
		bvalues[i] = obj.box_plot_data[i].v;
	}


	var pvvalues = new Array();
	var min = obj.pv_rate_data[0].v;
	var max = obj.pv_rate_data[0].v;
	for(var i =0, l=obj.pv_rate_data.length; i<l; i++ ) {
		pvvalues[i] = obj.pv_rate_data[i].v;
		if(pvvalues[i]<min)
			min = pvvalues[i];
		if(pvvalues[i]>max)
			max = pvvalues[i];
	}

	min = Math.round(min*10)/10;
	max = Math.round(max*10)/10;
	var pv = Math.round(pvvalues[pvvalues.length-1]*10)/10;

	$('#t_gstatus').replaceWith(content);

	$('#box-plot').sparkline(bvalues, { type:'box', width:'250px', height:'90px', boxFillColor:'#9ECAE1'});

	$('#pv-chart').sparkline(bvalues, { type:'line', width:'500px', height:'90px', lineColor:'#336699', fillColor:'', lineWidth:'3', spotColor:'#990000', minSpotColor:'#990000', maxSpotColor:'#990000'});

	var scurr = '<p style="text-align:left; font-size:2.5em; font-weight:bold; float:left;padding:0.2em;margin:0;">' + pv + '<sub style="text-align:left; font-weight:normal; font-size:0.3em;">(pv/sec)</sub></p>'
	var smin = '<p style="float:left; padding:0.2em;margin:0; margin-left:0.5em; text-align:left"><span style="text-align:left; font-weight:normal;">Min: ' + min + '</span><br/>';
	var smax = '<span style="text-align:left; font-weight:normal;">Max: ' + max + '</span></p>';

	$('#pv-current').replaceWith(scurr + smin + smax) 
}

function handleTopHosts(obj) {

	var content = '<table id="t_top_hosts" cellspacing="0" cellpadding="5" border="0" style="margin:auto;margin-bottom:1em">';
	content += '<caption>Top Blogs</caption>';
	content += '<tr><th>Blog</th><th>Visits</th></tr>';
	
	for(var i =0, l=obj.records.length; i<l; i++ ) {

		var color =  ( ((i+1)%2) == 0) ? "#ebebeb" : "#f9f9f9";
		content += '<tr style="font-size:1.1em; background-color:' + color + ';">';		
		content += '<td><a href="http://' + obj.records[i].hostname + '/">' + obj.records[i].hostname + '</a></td>';
		//content += '<td>' + obj.records[i].pv_count + '</td>';
		content += '<td style="font-weight:bold">' + obj.records[i].visit_count + '</td>';
		content += '</tr>';		
	}
	content += '</table>';


	$('#t_top_hosts').replaceWith(content);
}

function handleTopPages(obj) {

	var content = '<table id="t_top_pages" cellspacing="5" cellpadding="2" style="margin:auto; width:95%">';
	content += '<caption>Top Pages</caption>';

	for(var i=0, l=obj.records.length; i<l; i++) {

		content += '<tr>';
		
		if(i==0) {
			content += '<td>';
		}
		else {
			content += '<td style="border-top:1px solid #444;">';
		}

		content += '<div style="margin:5px; float:left; font-size:1.4em;"><a  class="pop" href="' + obj.records[i].url + '">' + trunc(obj.records[i].doc_title, 35) + '</a></div>';
		content += '<div style="float:right;vertical-align:top">' + obj.records[i].visit_count + '</div>';
		content += '</td>';
		content += '</tr>';		
	}

	content += '</table>';

	$('#t_top_pages').replaceWith(content);
}



function trunc(str, len)
{
	if (str) {
			if (str.length > len) {
			str = str.substring(0, len);
			str = str.replace(/\w+$/, '');
			str += " (...)"
	
			return str;
		}
		return str;
	}
	else {
		return '<emtpy>';
	}

}

function output(str) {
	$('#log').text(str);
}



		</script>
	</head>
	<body id="body" onload="init();">
		<div id="wrapper">

			<div id="container">

<table border="0" cellpadding="5" cellspacing="5">
	<tr>
		<td>
			<img src="./images/logo.png" width="296" height="146" alt="Blogs Dashboard" title="Blogs Dashboard" />
		</td>
		<td colspan="2">
			<div id="pv-rate" style="width:800px; height:146px;" class="box">
				<table id="t_pv_rate"  cellspacing="0" cellpadding="5" border="0" style="margin:auto;width:95%;">
					<caption>Traffic</caption>
					<tr><td style="text-align:center;"><p id="pv-chart" style="width:500px; float:left;padding:0;margin:0.2em;">Loading...</p><p id="pv-current"></p></td></tr>
				</table>
			</div>
		</td>
		<td rowspan="3" style="vertical-align:top">		
		<div id="new-blogs" style="vertical-align:top;">
			<ul id="blogticker">
				<li id="li_loading">Loading...</li>
			</ul>
		<div>	
		</td>
	</tr>
	<tr>
		<td style="vertical-align:top">
			<div id="global-status" style="width:320px; height:350px;" class="box">
				<table id="t_gstatus" cellspacing="0" cellpadding="10" border="0"></table>
			</div>
		</td>
		<td style="vertical-align:top">	
			<div id="popular-pages" style="height:650px; width:450px;"  class="box">
				<table id="t_top_pages" cellspacing="0" cellpadding="2" border="0" style="margin:auto"><tr><td>Loading...</td></tr></table>
			</div>		
		</td>
		<td style="vertical-align:top">
			<div id="top-hosts" style="height:650px;" class="box">
				<table id="t_top_hosts" cellspacing="0" cellpadding="5" border="0" style="margin:auto"><tr><td>Loading...</td></tr></table>
			</div>
		</td>
	</tr>
</table>

<div id="log"></div>
					
			</div> <!-- container -->
		</div> <!-- wrapper -->
		
	</body>
</html>
