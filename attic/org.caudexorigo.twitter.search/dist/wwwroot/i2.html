<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Twitter feed via WebSockets</title>
<script type="text/javascript" src="jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="swfobject.js"></script>
<script type="text/javascript" src="FABridge.js"></script>
<script type="text/javascript" src="web_socket.js"></script>
<script type="text/javascript">

WebSocket.__swfLocation = "WebSocketMain.swf";
var ws_host = "ws://" + window.location.host + "/";
var ws;

var counter = 0;
var max_stack =  10;
var speed = 500;
var re_url = new RegExp("(\\s|^)(http://[^\\s$]+)", "g");
var re_tuser = new RegExp("(\\s|^)@([\\w$]+)", "g");

function init() {

	if (window.WebSocket) {

		ws = new WebSocket(ws_host);
		output("Your browser rocks! It supports Web Sockets.");
	} else {
		output("This sucks! Your browser doesn't have Web Sockets.");
	}

	ws.onopen = function () {
		output("Web Socket Opened");
	};
	ws.onmessage = function (event) {
		try {
			
			try {
				addFirst(JSON.parse(event.data));
			}
			catch(e) {
				addFirst(eval('(' + event.data + ')'));
			}
		}
		catch(err) {
			output("oops! something is wrong: " + err.message);
		}

	};
	ws.onclose = function () {
		output("Web Socket Closed");		
	};
}


function removeLast() {
	$('ul#listticker li:last').animate({opacity: 0	}, speed).fadeOut(speed, function() {$(this).remove();});
	$('ul#listticker li:last').remove();
}

function addFirst(obj) {

	var mark = 0;
	while (($('ul#listticker').children().length > max_stack) && (mark<50)) {
		removeLast();
		mark++;
	}

	
	var text =  obj.text.replace(re_url, ' <a href=\"$2\" target=\"_blank\">$2</a>');
	text = text.replace(re_tuser, ' <a href=\"http://twitter.com/$2\" target=\"_blank\">@$2</a>');
	

	var first = '<li style="display:none">';
	first += '<img src="' + obj.profile_image_url + '" width="48" height="48" />';
	first += '<a href="http://twitter.com/from_user" class="item-title">' + obj.from_user + ' - ' + obj.created_at + '</a>';
	first += '<span class="item-text">' + text + '</span>';
	first += '</li>';
	$('ul#listticker').prepend(first);
	$('ul#listticker li:first').animate({opacity: 1 }, speed).fadeIn(speed);
}

function output(str) {
	$('#log').text(str);
}
</script>
<style type="text/css">
body {
font-family:"Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;font-size:76%;
}

body {
font-family:"Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;font-size:76%;
}

#listticker {
_height:80%; min-height:80%; width:750px; overflow:hidden; border-top:solid 1px black; padding:5px 10px 15px;
}


#listticker li {
border:solid 1px #DEDEDE; height:70px; list-style:none; margin:5px; padding:5px;
}

#listticker a {
}

#listticker .item-title {
display:block; font-weight:bold; margin-bottom:4px; font-size:1.2em;
}

#listticker .item-text {
display:block; font-size:1.2em;
}

#listticker img {
float:left; margin-right:15px; border:solid 1px #DEDEDE; padding:5px;
}
</style>

</head>

<body onload="init();">

<div id="log"></div>

<ul id="listticker"></ul>
</body>
</html>
